/*! ngImg
version: 0.0.1
build date: 2013-07-31
author: Robin Fan
https://github.com/pc035860/ngImg.git */
angular.module("ngImg",[]).provider("$imgPool",function(){var a={};return a.defaults={flushOnRouteChange:!0,idPrefix:"$imgPool",poolName:"default"},a.$get=["$cacheFactory","$rootScope",function(b,c){function d(a){return function(b,c){var d=a.get(b);return angular.isDefined(d)&&angular.isArray(d)?d.push(c||d[0].cloneNode(!0)):a.put(b,[c]),c}}function e(a){return function(b){var c=a.get(b);return angular.isDefined(c)&&angular.isArray(c)&&c.length>0?c.pop():void 0}}var f={};return a.defaults.flushOnRouteChange&&c.$on("$routeChangeSuccess",function(){angular.forEach(f,function(a,c){var d=b.get(c);angular.isDefined(d)&&(d.removeAll(),d.destroy())})}),function(c){var g=a.idPrefix+"."+(c||a.defaults.poolName);return cache=b.get(g)||b(g),wrap={},f[g]=!0,angular.forEach(cache,function(a,b){switch(b){case"put":wrap.put=d(cache);break;case"get":wrap.get=e(cache);break;default:wrap[b]=cache[b]}}),wrap}}],a}).provider("$loadImg",function(){var a={};return a.defaults={requestLimit:2},a.$get=["$imgPool","$q",function(b,c){function d(){if(0!==j.length&&f()){var a=j.shift(),b=a[0],c=a[1],e=a[2],h=angular.element(b),i=function(){h.unbind("load error"),angular.isFunction(e)&&e(this),g(),d()},k=function(){h.unbind("load error"),angular.isFunction(e)&&e(!1),g(),d()};h.bind("load",i),h.bind("error",k),h.prop("src",c)}}function e(a,b,c){j.push([a,b,c])}function f(){return k>0?(k--,!0):!1}function g(){k<a.defaults.requestLimit&&k++}function h(a,c,f,g){switch(arguments.length){case 3:case 2:angular.isString(c)&&(f=c,g=f)}var h=new Image;return e(h,a,function(d){if(angular.isString(f)&&d){var e=b(f);for(g=g||1;g--;)e.put(a,0===g?d:d.cloneNode(!0))}angular.isFunction(c)&&c(d)}),d(),h}function i(a,b,d,e){var f=[];return angular.forEach(a,function(a){var b=c.defer();h(a,function(a){$rootScope.$apply(function(){b.resolve(a)})},d,e),f.push(b.promise)}),c.all(f).then(function(a){angular.isFunction(b)&&b(a)}),f}var j=[],k=a.defaults.requestLimit;return function(a,b,c,d){return angular.isArray(a)?i(a,b,c,d):h(a,b,c,d)}}],a}).directive("ngImg",["$imgPool","$log","$timeout",function(a,b,c){return{restrict:"EA",compile:function(d){return d.html(""),function(d,e,f){function g(a,b){i(b)&&!j(b)&&(b=m(b,function(a,b){return a?b:void 0})),a.removeClass(j(b)?b.join(" "):b)}function h(a,b){i(b)&&!j(b)&&(b=m(b,function(a,b){return a?b:void 0})),b&&a.addClass(j(b)?b.join(" "):b)}var i=angular.isObject,j=angular.isArray,k=angular.equals,l=angular.copy,m=function(a,b,c){var d=[];return angular.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d},n=a(f.pool);d.$on("$destroy",function(){var a=e.find("img");a.length>0&&(a.remove(),n.put(a.prop("src"),a[0]))}),f.$observe("ngImg",function(a){var i,j,k=e.find("img");angular.isDefined(f.ngImgClass)&&(j=d.$eval(f.ngImgClass)),angular.isDefined(a)&&(0===k.length?(i=n.get(a),i?(e.append(i),j&&h(angular.element(i),j)):b.error("$imgPool failed to hit.",a)):k.prop("src")!==a&&(k.remove(),j&&g(k,j),n.put(k.prop("src"),k[0]),c(function(){i=n.get(a),i?(e.append(i),j&&h(angular.element(i),j)):b.error("$imgPool failed to hit.",a)})))}),function(){function a(a){var c=e.find("img");b&&!k(a,b)&&g(c,b),h(c,a),b=l(a)}var b,c="ngImgClass";d.$watch(f[c],a,!0),f.$observe("class",function(){var b=d.$eval(f[c]);a(b,b)})}()}}}}]);