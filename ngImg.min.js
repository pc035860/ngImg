/*! ngImg
version: 0.0.1
build date: 2013-07-29
author: Robin Fan
https://github.com/pc035860/ngImg.git */
angular.module("ngImg",[]).provider("$imgPool",function(){var a={};return a.defaults={flushOnRouteChange:!0,idPrefix:"$imgPool",poolName:"default"},a.$get=["$cacheFactory","$rootScope",function(b,c){function d(a){return function(b,c){var d=a.get(b);return angular.isDefined(d)&&angular.isArray(d)?d.push(c||d[0].cloneNode(!0)):a.put(b,[c]),c}}function e(a){return function(b){var c=a.get(b);return angular.isDefined(c)&&angular.isArray(c)&&c.length>0?c.pop():void 0}}var f={};return a.defaults.flushOnRouteChange&&c.$on("$routeChangeSuccess",function(){angular.forEach(f,function(a,c){var d=b.get(c);angular.isDefined(d)&&(d.removeAll(),d.destroy())})}),function(c){var g=a.idPrefix+"."+(c||a.defaults.poolName);return cache=b.get(g)||b(g),wrap={},f[g]=!0,angular.forEach(cache,function(a,b){switch(b){case"put":wrap.put=d(cache);break;case"get":wrap.get=e(cache);break;default:wrap[b]=cache[b]}}),wrap}}],a}).provider("$loadImg",function(){var a={};return a.defaults={requestLimit:2},a.$get=["$imgPool","$q",function(b,c){function d(){if(0!==j.length&&f()){var a=j.shift(),b=a[0],c=a[1],e=a[2],h=angular.element(b),i=function(){h.unbind("load error"),angular.isFunction(e)&&e(this),g(),d()},k=function(){h.unbind("load error"),angular.isFunction(e)&&e(!1),g(),d()};h.bind("load",i),h.bind("error",k),h.prop("src",c)}}function e(a,b,c){j.push([a,b,c])}function f(){return k>0?(k--,!0):!1}function g(){k<a.defaults.requestLimit&&k++}function h(a,c,f,g){switch(arguments.length){case 3:case 2:angular.isString(c)&&(f=c,g=f)}var h=new Image;return e(h,a,function(d){if(angular.isString(f)&&d){var e=b(f);for(g=g||1;g--;)e.put(a,0===g?d:d.cloneNode(!0))}angular.isFunction(c)&&c(d)}),d(),h}function i(a,b,d,e){var f=[];return angular.forEach(a,function(a){var b=c.defer();h(a,function(a){$rootScope.$apply(function(){b.resolve(a)})},d,e),f.push(b.promise)}),c.all(f).then(function(a){angular.isFunction(b)&&b(a)}),f}var j=[],k=a.defaults.requestLimit;return function(a,b,c,d){return angular.isArray(a)?i(a,b,c,d):h(a,b,c,d)}}],a}).directive("ngImg",["$imgPool","$log",function(a,b){return{restrict:"EA",controller:[function(){}],compile:function(c){return c.html(""),function(c,d,e){var f=a(e.pool);c.$on("$destroy",function(){var a=d.find("img");a.length>0&&(a.remove(),f.put(a.prop("src"),a[0]))}),e.$observe("ngImg",function(a){var c,e=d.find("img");angular.isDefined(a)&&(0===e.length?(c=f.get(a),c?d.append(c):b.error("$imgPool failed to hit.",a)):e.prop("src")!==a&&(c=f.get(a),c?(d.append(c),e.remove(),f.put(e.prop("src"),e[0])):b.error("$imgPool failed to hit.",a)))})}}}}]).directive("ngImgClass",[function(){var a="ngImgClass";return{require:"ngImg",restrict:"A",link:function(b,c,d){function e(a){m&&!j(a,m)&&f(m),g(a),m=k(a)}function f(a){h(a)&&!i(a)&&(a=l(a,function(a,b){return a?b:void 0})),c.find("img").removeClass(i(a)?a.join(" "):a)}function g(a){h(a)&&!i(a)&&(a=l(a,function(a,b){return a?b:void 0})),a&&c.find("img").addClass(i(a)?a.join(" "):a)}function h(a){return angular.isObject(a)}function i(a){return angular.isArray(a)}function j(a,b){return angular.equals(a,b)}function k(a){return angular.copy(a)}function l(a,b,c){var d=[];return angular.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d}var m;b.$watch(d[a],e,!0),d.$observe("class",function(){var c=b.$eval(d[a]);e(c,c)})}}}]);