/*! ngImg
version: 0.0.2
build date: 2014-06-14
author: Robin Fan
https://github.com/pc035860/ngImg.git */
angular.module("ngImg",[]).provider("$imgPool",function(){var a={},b={flushOnRouteChange:!0,cacheIdPrefix:"$imgPool",defaultPoolName:"default"};return a.config=function(a,c){if(angular.isObject(a))angular.extend(b,a);else{if(!angular.isString(a))return angular.copy(b);if(!angular.isDefined(c))return b[a];b[a]=c}},a.$get=["$cacheFactory","$rootScope",function(a,c){function d(a){return function(b,c){var d=a.get(b);return angular.isDefined(d)&&angular.isArray(d)?d.push(c||d[0].cloneNode(!0)):a.put(b,[c]),c}}function e(a){return function(b){var c=a.get(b);return angular.isDefined(c)&&angular.isArray(c)&&c.length>0?c.pop():void 0}}var f,g={};return b.flushOnRouteChange&&c.$on("$routeChangeSuccess",function(){angular.forEach(g,function(b,c){var d=a.get(c);angular.isDefined(d)&&(d.removeAll(),d.destroy())})}),f=function(c){var f=b.cacheIdPrefix+"."+(c||b.defaultPoolName),h=a.get(f)||a(f),i={};return g[f]=!0,angular.forEach(h,function(a,b){switch(b){case"put":i.put=d(h);break;case"get":i.get=e(h);break;default:i[b]=h[b]}}),i},f.config=b,f}],a}).provider("$loadImg",function(){var a={},b={requestLimit:2};return a.config=function(a,c){if(angular.isObject(a))angular.extend(b,a);else{if(!angular.isString(a))return angular.copy(b);if(!angular.isDefined(c))return b[a];b[a]=c}},a.$get=["$imgPool","$q","$rootScope","$document",function(a,c,d,e){function f(){if(0!==l.length&&h()){var a=l.shift(),b=a[0],c=a[1],d=a[2],e=angular.element(b),g=function(){e.unbind("load",g),e.unbind("error",j),(d||angular.noop)(this),i(),f()},j=function(){e.unbind("load",g),e.unbind("error",j),(d||angular.noop)(!1),i(),f()};e.bind("load",g),e.bind("error",j),e.prop("src",c)}}function g(a,b,c){l.push([a,b,c])}function h(){return m>0?(m--,!0):!1}function i(){m<b.requestLimit&&m++}function j(b,c,d,h){switch(arguments.length){case 3:case 2:angular.isString(c)&&(d=c,h=d)}angular.isString(d)||(d=a.config.defaultPoolName);var i=e[0].createElement("img");return g(i,b,function(e){if(e){var f=a(d);for(h=h||1;h--;)f.put(b,0===h?e:e.cloneNode(!0))}(c||angular.noop)(e)}),f(),i}function k(a,b,e,f){var g=[];return angular.forEach(a,function(a){var b=c.defer();j(a,function(a){d.$apply(function(){b.resolve(a)})},e,f),g.push(b.promise)}),c.all(g).then(function(a){(b||angular.noop)(a)}),g}var l=[],m=b.requestLimit;return function(a,b,c,d){return angular.isArray(a)?k(a,b,c,d):j(a,b,c,d)}}],a}).directive("ngImg",["$imgPool","$log","$timeout",function(a,b,c){return{restrict:"EA",compile:function(d){return d.html(""),function(d,e,f){function g(a,b){i(b)&&!j(b)&&(b=m(b,function(a,b){return a?b:void 0})),a.removeClass(j(b)?b.join(" "):b)}function h(a,b){i(b)&&!j(b)&&(b=m(b,function(a,b){return a?b:void 0})),b&&a.addClass(j(b)?b.join(" "):b)}var i=angular.isObject,j=angular.isArray,k=angular.equals,l=angular.copy,m=function(a,b,c){var d=[];return angular.forEach(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d},n=a(f.pool);d.$on("$destroy",function(){var a=e.find("img");a.length>0&&(a.remove(),n.put(a.prop("src"),a[0]))}),f.$observe("ngImg",function(a){var i,j,k=e.find("img");angular.isDefined(f.ngImgClass)&&(j=d.$eval(f.ngImgClass)),0===k.length?""!==a&&(i=n.get(a),i?(e.append(i),j&&h(angular.element(i),j)):b.error("$imgPool failed to hit.",a)):k.prop("src")!==a&&(k.remove(),j&&g(k,j),n.put(k.prop("src"),k[0]),c(function(){i=n.get(a),i?(e.append(i),j&&h(angular.element(i),j)):b.error("$imgPool failed to hit.",a)}))}),function(){function a(a){var c=e.find("img");b&&!k(a,b)&&g(c,b),h(c,a),b=l(a)}var b,c="ngImgClass";d.$watch(f[c],a,!0),f.$observe("class",function(){var b=d.$eval(f[c]);a(b,b)})}()}}}}]);